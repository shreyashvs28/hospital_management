<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - St. Seraphina's Hospital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .sidebar-link.active {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="hidden md:flex flex-col w-64 bg-white shadow-lg">
            <div class="flex items-center justify-center h-20 shadow-md px-4">
                <h1 class="text-2xl font-semibold text-gray-800">Admin Panel</h1>
            </div>

            <nav class="flex-1 px-2 py-4 space-y-2">
                <a href="#dashboard" class="sidebar-link flex items-center px-4 py-2 text-gray-700 rounded-md active">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> Dashboard
                </a>
                <a href="#doctors" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Doctors
                </a>
                <a href="#patients" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> Patients
                </a>
                <a href="#staff" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> Staff
                </a>
                <a href="#blood" data-src="../Blood/blood.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                     <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2.25c-5.18 0-9.42 4.01-9.42 8.94C2.58 16.12 12 22.5 12 22.5s9.42-6.38 9.42-11.31C21.42 6.26 17.18 2.25 12 2.25z"></path>
                    </svg> Blood
                </a>
                
                <a href="#laboratory" data-src="../lab/lab_dashboard.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"></path></svg> Laboratory
                </a>
                <a href="#ward" data-src="../ward/ward_dashboard.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6M9 11.25h6m-6 4.5h6M6.75 21v-2.25a2.25 2.25 0 0 1 2.25-2.25h6a2.25 2.25 0 0 1 2.25 2.25V21M6.75 3v2.25a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25V3"></path></svg> Ward
                </a>
                <a href="#pharmacy" data-src="../farmacy/dashboard.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 12l4.179 2.25m0 0l5.571 3 5.571-3m0 0l4.179-2.25L12 9.75l-5.571 3z"></path></svg> Pharmacy
                </a>
                <a href="#bill" data-src="../bill/bill_dashboard.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                     <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-1.5h5.25m-5.25 0h3m-3 0h-3m-2.25-4.5h16.5M3 3.75h16.5a1.5 1.5 0 0 1 1.5 1.5v13.5a1.5 1.5 0 0 1-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5V5.25a1.5 1.5 0 0 1 1.5-1.5Z"></path></svg> Bill
                </a>
                <a href="#emergency" data-src="../emergency/emergency.html" class="sidebar-link flex items-center px-4 py-2 text-gray-600 hover:bg-gray-200 rounded-md">
                     <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path></svg> Emergency
                </a>
                <a href="../auth/login.html" class="flex items-center px-4 py-2 mt-auto text-gray-600 hover:bg-red-200 rounded-md">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg> Logout
                </a>
            </nav>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <div class="flex items-center justify-between h-20 bg-white shadow-md px-6">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="text-gray-500 focus:outline-none focus:text-gray-700 md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="main-header" class="text-2xl font-semibold text-gray-800 ml-4">Dashboard</h1>
                </div>
                <div class="flex items-center">
                    <span class="text-gray-600 mr-4">Welcome, Admin!</span>
                    <img class="w-10 h-10 rounded-full object-cover" src="https://placehold.co/100x100/4a5568/ffffff?text=A" alt="Admin Avatar">
                </div>
            </div>

            <!-- Mobile Sidebar (hidden by default) -->
            <div id="mobile-sidebar" class="hidden md:hidden fixed inset-0 flex z-40">
                <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black opacity-50"></div>
                <div class="relative flex-1 flex flex-col max-w-xs w-full bg-white">
                    <div class="absolute top-0 right-0 -mr-12 pt-2">
                        <button id="close-sidebar" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:bg-gray-600">
                             <svg class="h-6 w-6 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                    </div>
                    <div class="flex items-center justify-center h-20 shadow-md">
                        <h1 class="text-2xl font-bold text-blue-600">St. Seraphina's</h1>
                    </div>
                    <nav id="mobile-nav" class="flex-1 px-2 py-4 space-y-2">
                         <!-- Mobile nav links will be dynamically populated -->
                    </nav>
                </div>
            </div>

            <main class="p-6">
                <!-- External page iframe: used to load full pages like blood, bill, emergency, pharmacy -->
                <div id="external-frame-container" class="mb-6 hidden">
                    <iframe id="external-frame" src="about:blank" class="w-full h-[70vh] bg-white rounded-lg shadow-md border" frameborder="0" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                </div>
                <!-- Dashboard View -->
                <div id="dashboard-view" class="page-view">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 ">
                        <div class="bg-white p-6 rounded-lg shadow-md ">
                            <h3 class="text-lg font-semibold text-gray-700 ">Total Doctors</h3>
                            <p class="text-3xl font-bold text-blue-600" data-metric="doctors">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md ">
                            <h3 class="text-lg font-semibold text-gray-700 ">Total Patients</h3>
                            <p class="text-3xl font-bold text-green-600" data-metric="patients">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md ">
                            <h3 class="text-lg font-semibold text-gray-700 ">Total Staff</h3>
                            <p class="text-3xl font-bold text-yellow-600" data-metric="staff">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md ">
                            <h3 class="text-lg font-semibold text-gray-700 ">Bed Occupancy</h3>
                            <p class="text-3xl font-bold text-red-600">85%</p>
                        </div>
                    </div>
                </div>

                <!-- Doctors View -->
                <div id="doctors-view" class="page-view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Doctors List</h2>
                            <button id="add-doctor-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add Doctor</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 border-b">Name</th>
                                        <th class="py-2 px-4 border-b">Specialty</th>
                                        <th class="py-2 px-4 border-b">Contact</th>
                                        <th class="py-2 px-4 border-b">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="doctors-table-body">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- Patients View -->
                <div id="patients-view" class="page-view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Patients List</h2>
                            <button id="add-patient-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Add Patient</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 border-b">Name</th>
                                        <th class="py-2 px-4 border-b">Age</th>
                                        <th class="py-2 px-4 border-b">Condition</th>
                                        <th class="py-2 px-4 border-b">Admitted On</th>
                                        <th class="py-2 px-4 border-b">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patients-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Staff View -->
                <div id="staff-view" class="page-view hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Staff List</h2>
                            <button id="add-staff-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600">Add Staff</button>
                        </div>
                         <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="py-2 px-4 border-b">Name</th>
                                        <th class="py-2 px-4 border-b">Role</th>
                                        <th class="py-2 px-4 border-b">Department</th>
                                        <th class="py-2 px-4 border-b">Contact</th>
                                        <th class="py-2 px-4 border-b">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staff-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Generic Overview Views -->
                <div id="blood-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Blood Bank Overview</h2>
                    <p class="mt-2 text-gray-600">This section provides an overview of the blood inventory.</p>
                </div>
                <div id="reports-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Reports Overview</h2>
                    <p class="mt-2 text-gray-600">This section provides an overview of hospital reports.</p>
                </div>
                <div id="laboratory-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Laboratory Overview</h2>
                    <p class="mt-2 text-gray-600">This section provides an overview of lab test statuses.</p>
                </div>
                <div id="ward-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Ward Overview</h2>
                    <p class="mt-2 text-gray-600">This section provides an overview of ward occupancy.</p>
                </div>
                <div id="pharmacy-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Pharmacy Overview</h2>
                    <p class="mt-2 text-gray-600">This section provides an overview of the pharmacy inventory.</p>
                </div>
                <div id="bill-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md" src="../bill/bill_dashboard.html">
                    <h2 class="text-xl font-semibold">Billing Overview</h2>
                     <p class="mt-2 text-gray-600">This section provides an overview of patient billing.</p>
                </div>
                 <div id="emergency-view" class="page-view hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold">Emergency Room Overview</h2>
                     <p class="mt-2 text-gray-600">This section provides a real-time overview of the ER.</p>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Generic Add/Edit Modal -->
    <div id="entry-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6"></h2>
            <form id="entry-form">
                <input type="hidden" id="entry-id">
                <div id="form-fields" class="space-y-4">
                    <!-- Fields will be injected here -->
                </div>
                <div class="mt-8 pt-6 border-t flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
            <h2 id="confirm-title" class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h2>
            <p id="confirm-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                 <button id="confirm-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-300">Cancel</button>
                 <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- STATE MANAGEMENT ---
            let appState = {
                doctors: [],
                patients: [],
                staff: [],
                currentView: 'dashboard',
                editingType: null,
                editingId: null,
                deletingInfo: { type: null, id: null }
            };

            // --- DOM ELEMENTS ---
            const mainHeader = document.getElementById('main-header');
            const pageViews = document.querySelectorAll('.page-view');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const mobileNav = document.getElementById('mobile-nav');

            const entryModal = document.getElementById('entry-modal');
            const modalTitle = document.getElementById('modal-title');
            const entryForm = document.getElementById('entry-form');
            const formFields = document.getElementById('form-fields');
            const entryIdInput = document.getElementById('entry-id');
            const cancelBtn = document.getElementById('cancel-btn');

            const confirmModal = document.getElementById('confirm-modal');
            const confirmText = document.getElementById('confirm-text');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            // Mobile sidebar elements
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mobileSidebar = document.getElementById('mobile-sidebar');
            const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
            const closeSidebarBtn = document.getElementById('close-sidebar');


            // --- LOCAL STORAGE ---
            const saveData = () => {
                localStorage.setItem('hospitalData', JSON.stringify({
                    doctors: appState.doctors,
                    patients: appState.patients,
                    staff: appState.staff
                }));
                // Also sync doctors to patient dashboard state so patients see updated doctor list
                try {
                    const patientKey = 'patient_dashboard_state_v1';
                    const raw = localStorage.getItem(patientKey);
                    let pstate = raw ? JSON.parse(raw) : null;
                    if (!pstate) pstate = { profile: {}, appointments: [], reports: [], doctors: [] };
                    // patient expects an array of strings like "Dr. Name (Specialty)"
                    if (Array.isArray(appState.doctors)) {
                        pstate.doctors = appState.doctors.map(d => {
                            const name = d.name || '';
                            const specialty = d.specialty ? ` (${d.specialty})` : '';
                            return `${name}${specialty}`.trim();
                        });
                    } else {
                        pstate.doctors = pstate.doctors || [];
                    }
                    localStorage.setItem(patientKey, JSON.stringify(pstate));
                    try {
                        // notify other open tabs (patient page) about doctor list update
                        const bc = new BroadcastChannel('hospital-sync');
                        bc.postMessage({ type: 'doctors-updated', doctors: pstate.doctors });
                        bc.close();
                    } catch (e) {
                        // BroadcastChannel may not be available in older browsers
                    }
                } catch (e) {
                    console.warn('failed to sync doctors to patient state', e);
                }
            };

            const loadData = () => {
                const data = JSON.parse(localStorage.getItem('hospitalData'));
                if (data) {
                    appState.doctors = data.doctors || [];
                    appState.patients = data.patients || [];
                    appState.staff = data.staff || [];
                }
                // Merge doctors from patient dashboard state if present (so admin sees the same live list)
                try {
                    const patientKey = 'patient_dashboard_state_v1';
                    const raw = localStorage.getItem(patientKey);
                    if (raw) {
                        const pstate = JSON.parse(raw);
                        if (pstate && Array.isArray(pstate.doctors)) {
                            // Convert existing admin objects to formatted strings for comparison
                            const existingNames = (appState.doctors||[]).map(x => {
                                if (typeof x === 'string') return x;
                                return `${x.name || ''}${x.specialty ? ` (${x.specialty})` : ''}`.trim();
                            });
                            // For each patient-side string, if it's not represented in admin list, add as object
                            pstate.doctors.forEach((ds, idx) => {
                                if (!existingNames.includes(ds)) {
                                    // parse name and specialty from string like 'Dr. X (Spec)'
                                    const m = ds.match(/^\s*(.*?)\s*(?:\((.*)\))?\s*$/);
                                    const name = m ? (m[1]||ds) : ds;
                                    const specialty = m && m[2] ? m[2] : '';
                                    appState.doctors.push({ id: Date.now() + idx, name: name, specialty: specialty, contact: '' });
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.warn('failed to merge patient doctors', e);
                }
            };

            // --- RENDERING & UI ---
            const renderDashboardMetrics = () => {
                document.querySelector('[data-metric="doctors"]').textContent = appState.doctors.length;
                document.querySelector('[data-metric="patients"]').textContent = appState.patients.length;
                document.querySelector('[data-metric="staff"]').textContent = appState.staff.length;
            };

            const renderTable = (type, data, tableBodyId, fieldsConfig) => {
                const tableBody = document.getElementById(tableBodyId);
                tableBody.innerHTML = '';
                if (data.length === 0) {
                    const fieldCount = Object.keys(fieldsConfig).length + 2; // +1 for actions, +1 for implicit index
                    tableBody.innerHTML = `<tr><td colspan="${fieldCount}" class="text-center py-4 text-gray-500">No entries found.</td></tr>`;
                    return;
                }
                data.forEach(item => {
                    const row = document.createElement('tr');
                    let cells = '';
                    Object.keys(fieldsConfig).forEach(key => {
                        cells += `<td class="py-2 px-4 border-b">${item[key] || ''}</td>`;
                    });
                    
                    cells += `
                        <td class="py-2 px-4 border-b">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 mr-2" data-type="${type}" data-id="${item.id}">Edit</button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-type="${type}" data-id="${item.id}" data-name="${item.name}">Delete</button>
                        </td>`;

                    row.innerHTML = cells;
                    tableBody.appendChild(row);
                });
            };

            const renderAllTables = () => {
                renderTable('doctors', appState.doctors, 'doctors-table-body', doctorFields);
                renderTable('patients', appState.patients, 'patients-table-body', patientFields);
                renderTable('staff', appState.staff, 'staff-table-body', staffFields);
            }

            const switchView = (viewName) => {
                appState.currentView = viewName;

                // Find a sidebar link that corresponds to this view
                let matchedLink = null;
                sidebarLinks.forEach(link => {
                    if (link.getAttribute('href') && link.getAttribute('href').endsWith(`#${viewName}`)) matchedLink = link;
                });

                // If link has a data-src attribute, load the external page into the iframe
                const externalContainer = document.getElementById('external-frame-container');
                const externalFrame = document.getElementById('external-frame');
                if (matchedLink && matchedLink.dataset && matchedLink.dataset.src) {
                    // hide internal views and show iframe
                    pageViews.forEach(view => view.classList.add('hidden'));
                    externalFrame.src = matchedLink.dataset.src;
                    externalContainer.classList.remove('hidden');
                    mainHeader.textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
                } else {
                    // show internal view
                    externalContainer.classList.add('hidden');
                    pageViews.forEach(view => view.classList.add('hidden'));
                    const targetView = document.getElementById(`${viewName}-view`);
                    if (targetView) targetView.classList.remove('hidden');
                    mainHeader.textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
                }

                // update active link styling
                sidebarLinks.forEach(link => {
                    if (link.getAttribute('href') && link.getAttribute('href').endsWith(`#${viewName}`)) link.classList.add('active'); else link.classList.remove('active');
                });

                closeMobileSidebar();
            };
            
            const createFormFields = (fieldsConfig) => {
                formFields.innerHTML = '';
                for (const key in fieldsConfig) {
                    const config = fieldsConfig[key];
                    const fieldWrapper = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = key;
                    label.className = "block text-sm font-medium text-gray-700";
                    label.textContent = config.label;

                    const input = document.createElement('input');
                    input.type = config.type;
                    input.id = key;
                    input.name = key;
                    input.className = "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500";
                    input.required = true;
                    
                    fieldWrapper.appendChild(label);
                    fieldWrapper.appendChild(input);
                    formFields.appendChild(fieldWrapper);
                }
            };
            
            const openModal = (type, id = null) => {
                appState.editingType = type;
                appState.editingId = id;
                entryForm.reset();
                entryIdInput.value = id || '';
                
                const configs = { doctors: doctorFields, patients: patientFields, staff: staffFields };
                const fieldsConfig = configs[type];
                createFormFields(fieldsConfig);

                const getSingular = (str) => {
                    if (str === 'staff') return 'Staff Member';
                    if (str.endsWith('s')) return str.slice(0, -1);
                    return str;
                };

                if (id) { // Editing existing entry
                    modalTitle.textContent = `Edit ${getSingular(type)}`;
                    const item = appState[type].find(i => i.id == id);
                    if (item) {
                        for (const key in fieldsConfig) {
                            document.getElementById(key).value = item[key];
                        }
                    }
                } else { // Adding new entry
                     modalTitle.textContent = `Add New ${getSingular(type)}`;
                }
                entryModal.classList.remove('hidden');
            };

            const closeModal = (modalElement) => {
                modalElement.classList.add('hidden');
            }
            
            const openConfirmModal = (type, id, name) => {
                appState.deletingInfo = { type, id };
                confirmText.textContent = `You are about to delete the record for ${name}. This action cannot be undone.`;
                confirmModal.classList.remove('hidden');
            };

            // --- FORM & CRUD LOGIC ---
            const doctorFields = {
                name: { label: 'Name', type: 'text' },
                specialty: { label: 'Specialty', type: 'text' },
                contact: { label: 'Contact', type: 'tel' }
            };

            const patientFields = {
                name: { label: 'Name', type: 'text' },
                age: { label: 'Age', type: 'number' },
                condition: { label: 'Condition', type: 'text' },
                admittedOn: { label: 'Admitted On', type: 'date' }
            };
            
            const staffFields = {
                name: { label: 'Name', type: 'text' },
                role: { label: 'Role', type: 'text' },
                department: { label: 'Department', type: 'text' },
                contact: { label: 'Contact', type: 'tel' }
            };
            
            entryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(entryForm);
                const data = {};
                const fieldsConfig = { doctors: doctorFields, patients: patientFields, staff: staffFields }[appState.editingType];
                for (const key in fieldsConfig) {
                    data[key] = formData.get(key);
                }

                if (appState.editingId) { // Update
                    const index = appState[appState.editingType].findIndex(i => i.id == appState.editingId);
                    if (index !== -1) {
                       appState[appState.editingType][index] = { ...appState[appState.editingType][index], ...data };
                    }
                } else { // Create
                    data.id = Date.now();
                    appState[appState.editingType].push(data);
                }
                
                saveData();
                renderAllTables();
                renderDashboardMetrics();
                closeModal(entryModal);
            });
            
            confirmDeleteBtn.addEventListener('click', () => {
                const { type, id } = appState.deletingInfo;
                if (type && id) {
                    appState[type] = appState[type].filter(item => item.id != id);
                    saveData();
                    renderAllTables();
                    renderDashboardMetrics();
                    closeModal(confirmModal);
                }
            });


            // --- EVENT LISTENERS ---
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.hash.substring(1);
                    switchView(viewName);
                });
            });

            document.getElementById('add-doctor-btn').addEventListener('click', () => openModal('doctors'));
            document.getElementById('add-patient-btn').addEventListener('click', () => openModal('patients'));
            document.getElementById('add-staff-btn').addEventListener('click', () => openModal('staff'));

            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) {
                    const type = e.target.dataset.type;
                    const id = e.target.dataset.id;
                    openModal(type, id);
                }
                if (e.target.classList.contains('delete-btn')) {
                    const type = e.target.dataset.type;
                    const id = e.target.dataset.id;
                    const name = e.target.dataset.name;
                    openConfirmModal(type, id, name);
                }
            });

            cancelBtn.addEventListener('click', () => closeModal(entryModal));
            confirmCancelBtn.addEventListener('click', () => closeModal(confirmModal));
            
            // Mobile Sidebar Listeners
            const openMobileSidebar = () => mobileSidebar.classList.remove('hidden');
            const closeMobileSidebar = () => mobileSidebar.classList.add('hidden');

            sidebarToggle.addEventListener('click', openMobileSidebar);
            closeSidebarBtn.addEventListener('click', closeMobileSidebar);
            mobileSidebarOverlay.addEventListener('click', closeMobileSidebar);
            
            const populateMobileNav = () => {
                mobileNav.innerHTML = '';
                sidebarLinks.forEach(link => {
                    const newLink = link.cloneNode(true);
                    // preserve data-src if present
                    if (link.dataset && link.dataset.src) newLink.dataset.src = link.dataset.src;
                    newLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const viewName = (newLink.getAttribute('href') || '').split('#')[1] || '';
                        switchView(viewName);
                    });
                    mobileNav.appendChild(newLink);
                });
            };

            // --- INITIALIZATION ---
            const initializeApp = () => {
                loadData();
                renderDashboardMetrics();
                renderAllTables();
                const initialView = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
                switchView(initialView);
                populateMobileNav();
            };

            initializeApp();
        });
    </script>

</body>
</html>

